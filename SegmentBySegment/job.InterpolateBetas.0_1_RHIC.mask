title, "SBS for RHIC";
option, -echo, warn, -info;
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
!  RHIC definition
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
beam, mass=%(MASS)s, charge=%(CHARGE)s, gamma=%(GAMMA)s, exn=%(EMX)s, eyn=%(EMY)s, sige=%(SIGE)s;
!--- calling sequence => beam switch handled inside python
call, file="%(MPATH)s/%(BEAM)s";
call, file="%(BBPATH)s/defs/rhic_utilities.madx";

!--- change bpms names
call,file="%(BBPATH)s/defs/BPMSdef";
select,flag=seqedit,pattern=BPM;select,flag=seqedit,pattern=CPLMON;
seqedit,sequence=rhic;remove,element=selected;
call,file="%(BBPATH)s/defs/BPMSinstall";endedit;
use,sequence=rhic;

!--- change GAMMAT
call,file="%(BBPATH)s/defs/GAMMATdefs";
select,flag=seqedit,pattern=QJGTP;
select,flag=seqedit,pattern=QJQ;
select,flag=seqedit,pattern=QGT;
seqedit,sequence=rhic;remove,element=selected;
call,file="%(BBPATH)s/defs/GAMMATinstall";endedit;
use,sequence=rhic;

!--- tunes, chroms
Qx := %(QX)s; Qy := %(QY)s;
chromX := %(CHROMX)s;chromY := %(CHROMY)s;
exec, setarcquads; exec, setchrom;


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
! End RHIC definition
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
seqedit, sequence=rhic; 
flatten;
cycle, start=%(START)s;
endedit;

use, period=rhic;
select, flag=twiss, clear;
select, flag=twiss, range=%(ENDAT)s;
select, flag=twiss, range=%(STARTFROM)s, column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
twiss, file="%(PATH)s/StartPoint.twiss";

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! normal propogation

seqedit, sequence=rhic; 
cycle, start=%(STARTFROM)s;
endedit;
use, period=rhic, range=%(STARTFROM)s/%(ENDAT)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=instrument,column=name,s,L, K1l;
twiss, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss_%(LABEL)s_nom.dat";

 

use, period=rhic, range=%(STARTFROM)s/%(ENDAT)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;


twiss,betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss_%(LABEL)s.dat";

!!!!!!!!!!!!!!!!!!!!!!!!!
!
!  Write here correction
!
!!!!!!!!!!!!!!!!!!!!!!!!!



twiss, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss_%(LABEL)s_play.dat";

system, "python %(PATH)s/getfterms_RHIC.py -p %(PATH)s/ -l %(LABEL)s  -f 0  -e %(EXP)s -s %(STARTFROM)s";
!stop;
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
!  Remove correction here before you continue
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!



twiss, betx=%(BETX)s+%(ERRBETX)s, alfx=%(ALFX)s, bety=%(BETY)s+%(ERRBETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.b+.dat";
twiss, betx=%(BETX)s-%(ERRBETX)s, alfx=%(ALFX)s, bety=%(BETY)s-%(ERRBETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.b-.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s+%(ERRALFX)s, bety=%(BETY)s, alfy=%(ALFY)s+%(ERRALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.a+.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s-%(ERRALFX)s, bety=%(BETY)s, alfy=%(ALFY)s-%(ERRALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.a-.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s+%(ERRDX)s,dy=%(DY)s+%(ERRDY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.d+.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s-%(ERRDX)s,dy=%(DY)s-%(ERRDY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.d-.dat";


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! back propogation

seqedit, sequence=rhic; 
cycle, start=%(ENDAT)s;
flatten;reflect; ! reverse command
endedit;

use, period=rhic, range=%(ENDAT)s/%(STARTFROM)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s, file="%(PATH)s/twiss_%(LABEL)s_nom_back.dat";

 

use, period=rhic, range=%(ENDAT)s/%(STARTFROM)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;



twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss_%(LABEL)s_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss_%(LABEL)s_play_back.dat";
twiss, betx=%(ENDBX)s+%(ERRENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s+%(ERRENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.b+_back.dat";
twiss, betx=%(ENDBX)s-%(ERRENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s-%(ERRENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.b-_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s+%(ERRALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s+%(ERRALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.a+_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s-%(ERRALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s-%(ERRALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.a-_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s+%(ERRDENDX)s,dy=%(DENDY)s+%(ERRDENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.d+_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s-%(ERRDENDX)s,dy=%(DENDY)s-%(ERRDENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.d-_back.dat";


stop;

