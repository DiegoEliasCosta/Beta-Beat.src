title, "V6.5: new IR3/7, moved Q3 in IR1/2/5/8 -  March 2004" ;

 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.503 db";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.5/toolkit lt";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.500/ ds";



 option, -echo, -info,  warn;
 call,   file = "db/V6.5.seq";
call,   file = "db/V6.5.inj.str";
!call, file= "/nfs/cs-ccr-nfs4/lhc_data/OP_DATA/Betabeat/Extractions/str_inj.str";

! temporaery compensation of wrong sign in LSA
!temp = (-1 * kq4.lr7);
!kq4.lr7 := temp;

beam, particle = proton, sequence=LHCB1, energy = 450.0, bv=1;
beam, particle = proton, sequence=LHCB2, energy = 450.0, bv=-1;


seqedit, sequence=%(ACCEL)s; 
flatten;
cycle, start=%(START)s;
endedit;

use, period=%(ACCEL)s;
select, flag=twiss, clear;
select, flag=twiss, range=%(STARTFROM)s, column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
twiss, file="%(PATH)s/StartPoint.twiss";

use, period=%(ACCEL)s;
select, flag=twiss, clear;
select, flag=twiss, range=%(ENDAT)s, column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
twiss, file="%(PATH)s/EndPoint.twiss";



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!mathing
!call, file="%(PATH)s/matchjob4_%(LABEL)s_sbs.madx";
!!!!!!!!!!! end matching



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! normal propogation

seqedit, sequence=%(ACCEL)s; 
cycle, start=%(STARTFROM)s;
endedit;
use, period=%(ACCEL)s, range=%(STARTFROM)s/%(ENDAT)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=instrument,column=name,s,L, K1l;
twiss, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss_%(LABEL)s_nom.dat";

 

use, period=%(ACCEL)s, range=%(STARTFROM)s/%(ENDAT)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;


twiss,betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss_%(LABEL)s.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss_%(LABEL)s_play.dat";
twiss, betx=%(BETX)s+%(ERRBETX)s, alfx=%(ALFX)s, bety=%(BETY)s+%(ERRBETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.b+.dat";
twiss, betx=%(BETX)s-%(ERRBETX)s, alfx=%(ALFX)s, bety=%(BETY)s-%(ERRBETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.b-.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s+%(ERRALFX)s, bety=%(BETY)s, alfy=%(ALFY)s+%(ERRALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.a+.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s-%(ERRALFX)s, bety=%(BETY)s, alfy=%(ALFY)s-%(ERRALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.a-.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s+%(ERRDX)s,dy=%(DY)s+%(ERRDY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.d+.dat";
twiss, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s-%(ERRDX)s,dy=%(DY)s-%(ERRDY)s,dpx=%(DPX)s,dpy=%(DPY)s, file="%(PATH)s/twiss.d-.dat";



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! back propagation


seqedit, sequence=%(ACCEL)s; 
cycle, start=%(ENDAT)s;
flatten;reflect; ! reverse command
endedit;

use, period=%(ACCEL)s, range=%(ENDAT)s/%(STARTFROM)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s, file="%(PATH)s/twiss_%(LABEL)s_nom_back.dat";

 

use, period=%(ACCEL)s, range=%(ENDAT)s/%(STARTFROM)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;



twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss_%(LABEL)s_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss_%(LABEL)s_play_back.dat";
twiss, betx=%(ENDBX)s+%(ERRENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s+%(ERRENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.b+_back.dat";
twiss, betx=%(ENDBX)s-%(ERRENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s-%(ERRENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.b-_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s+%(ERRALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s+%(ERRALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.a+_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s-%(ERRALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s-%(ERRALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.a-_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s+%(ERRDENDX)s,dy=%(DENDY)s+%(ERRDENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.d+_back.dat";
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s-%(ERRDENDX)s,dy=%(DENDY)s-%(ERRDENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss.d-_back.dat";


stop;

