title, "V6.5: new IR3/7, moved Q3 in IR1/2/5/8 -  March 2004" ;

 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.503 db5";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.503 db";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.5/toolkit lt";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.500/ ds";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/ATS_V6.503 ats"; ! To allow to use ATS optics




 option, -echo, -info,  warn;
 call,   file = "db/as-built/V6.5.seq";
!call,   file = "db/as-built/V6.5.inj.str";
call,  file="%(PATH)s/modifiers.madx";
call, file = "/afs/cern.ch/eng/lhc/optics/V6.503//install_additional_elements.madx";

!call, file= "/nfs/cs-ccr-nfs4/lhc_data/OP_DATA/Betabeat/Extractions/str_inj.str";



! temporaery compensation of wrong sign in LSA
!temp = (-1 * kq4.lr7);
!kq4.lr7 := temp;

beam, particle = proton, sequence=LHCB1, energy = 450.0, bv=1;
beam, particle = proton, sequence=LHCB2, energy = 450.0, bv=-1;





seqedit, sequence=%(ACCEL)s;
flatten;
install, element=BGI,class=MARKER,at=real;
cycle, start=%(START)s;
endedit;


seqedit, sequence=LHCB1;
flatten;
install, element=BGI_B1,class=MARKER,at=6794.45142;
endedit;


seqedit, sequence=LHCB2;
flatten;
install, element=BGI_B2,class=MARKER,at=13255.4495;
endedit;

use, period=%(ACCEL)s;
select, flag=twiss, clear;
select, flag=twiss, range=%(ENDAT)s;
select, flag=twiss, range=%(STARTFROM)s, column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy, wx, phix, wy, phiy;
twiss, file="%(PATH)s/StartPoint.twiss";



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!mathing
!call, file="%(PATH)s/matchjob4_%(LABEL)s_sbs.madx";
!!!!!!!!!!! end matching



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! normal propagation


!!
!!  Start at the first BPM
!!

seqedit, sequence=%(ACCEL)s;
cycle, start=%(STARTFROM)s;
endedit;



!!
!! Save initial beta in beta0 variable
!!

use, period=%(ACCEL)s, range=%(STARTFROM)s/%(STARTFROM)s;  ! Just the starting element for speed
savebeta,label=b0, place=%(STARTFROM)s;
twiss ,chrom, betx=%(BETX)s, alfx=%(ALFX)s, bety=%(BETY)s, alfy=%(ALFY)s,dx=%(DX)s,dy=%(DY)s,dpx=%(DPX)s,dpy=%(DPY)s, wx=%(WX)s, phix=%(PHIX)s, wy=%(WY)s, phiy=%(PHIY)s;

!!
!!!! Matching for coupling initial cond, R matrix
!!

option,-echo,-info;  ! otherwise the output is somewhat confusing
getfterms(bpmname): macro = {
    savebeta, label=b1, place=bpmname;  ! This will update b1 with all the betas and coupling input
    twiss, beta0=b0, chrom, R11=ir11 ,R12=ir12, R21=ir21, R22=ir22, table;
    
    savebeta, label=b1, place=bpmname;
    twiss,beta0=b0, chrom, R11=ir11,R12=ir12,R21=ir21,R22=ir22,file="%(PATH)s/twiss_%(LABEL)s.dat";
    

    NORMR=sqrt(1+table(twiss, bpmname, R11)*table(twiss, bpmname, R22)-table(twiss, bpmname, R12)*table(twiss, bpmname, R21));

    !--- Gb is actually inv(Gb)
    Ga11=1/sqrt(table(twiss, bpmname,BETX));                            Ga22=sqrt(table(twiss, bpmname,BETX));
    Ga21= table(twiss, bpmname,ALFX)/sqrt(table(twiss, bpmname,BETX));  Ga12=0;

    Gb21=-table(twiss, bpmname,ALFY)/sqrt(table(twiss, bpmname,BETY));  Gb12=0;
    Gb11=sqrt(table(twiss,bpmname,BETY));                               Gb22=1/sqrt(table(twiss, bpmname,BETY));

    R11=table(twiss, bpmname,R11)/NORMR;   R12=table(twiss, bpmname,R12)/NORMR; 
    R21=table(twiss, bpmname,R21)/NORMR;   R22=table(twiss, bpmname,R22)/NORMR; 

    CP11= R22*Gb11-R12*Gb21;  CP12= R22*Gb12-R12*Gb22;
    CP21=-R21*Gb11+R11*Gb21;  CP22=-R21*Gb12+R11*Gb22;

    C11=Ga11*CP11+Ga12*CP21;  C12=Ga11*CP12+Ga12*CP22;
    C21=Ga21*CP11+Ga22*CP21;  C22=Ga21*CP12+Ga22*Cp22;

    GAMMA2=1-(C11*C22-C12*C21);

    f1001r = ( C12 - C21)/4/GAMMA2;
    f1001i = ( C11 + C22)/4/GAMMA2;
    f1010r = (-C12 - C21)/4/GAMMA2;
    f1010i = ( C11 - C22)/4/GAMMA2;
};
option, echo;

select, flag=twiss, clear;
select, flag=twiss, pattern=BPM ,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy, wx, phix, wy, phiy;

MATCH,USE_MACRO;
VARY, name=ir11, step=0.00001;
VARY, name=ir12, step=0.00001;
VARY, name=ir21, step=0.00001;
VARY, name=ir22, step=0.00001;

M1: MACRO={
    exec, getfterms(%(STARTFROM)s);
}

 CONSTRAINT, EXPR= f1001r= %(F1001R)f;
 CONSTRAINT, EXPR= f1001i= %(F1001I)f;
 CONSTRAINT, EXPR= f1010r= %(F1010R)f;
 CONSTRAINT, EXPR= f1010i= %(F1010I)f;

    lmdif, TOLERANCE=1.0E-6;
ENDMATCH;

option,-echo,-info;  ! otherwise the output is somewhat confusing
sel_LHCB1(): macro = {
	beam, particle = proton, sequence=front_prop, energy = 450.0, bv=1;
	beam, particle = proton, sequence=back_prop, energy = 450.0, bv=1;
};
sel_LHCB2(): macro = {
	beam, particle = proton, sequence=front_prop, energy = 450.0, bv=-1;
	beam, particle = proton, sequence=back_prop, energy = 450.0, bv=-1;
};
option, echo;

EXTRACT, SEQUENCE=%(ACCEL)s, FROM=%(STARTFROM)s, TO=%(ENDAT)s, NEWNAME=front_prop;

EXTRACT, SEQUENCE=%(ACCEL)s, FROM=%(STARTFROM)s, TO=%(ENDAT)s, NEWNAME=back_prop;
seqedit, sequence=back_prop;
cycle, start=%(ENDAT)s;
flatten;reflect; ! reverse command
endedit;

exec, sel_%(ACCEL)s();  ! To select the corresponding beams


!!! Normal propagation

use, period=front_prop, range=%(STARTFROM)s/%(ENDAT)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=rbend;
select, flag=twiss, class=tkicker;
select, flag=twiss,pattern="XRP";
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy, L,K1l,wx,phix,wy,phiy;
twiss, beta0=b1, chrom, file="%(PATH)s/twiss_%(LABEL)s.dat";

!!! Back propagation

use, period=back_prop, range=%(ENDAT)s/%(STARTFROM)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=rbend;
select, flag=twiss,pattern="XRP";
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss_%(LABEL)s_back.dat";


!!! Loading corrections
call,  file="%(PATH)s/corrections.madx";


!!! Corrected normal propagation

use, period=front_prop, range=%(STARTFROM)s/%(ENDAT)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=rbend;
select, flag=twiss, class=tkicker;
select, flag=twiss,pattern="XRP";
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy, L,K1l,wx,phix,wy,phiy;
twiss, beta0=b1, chrom, file="%(PATH)s/twiss_%(LABEL)s_cor.dat";

!!! Corrected back propagation

use, period=back_prop, range=%(ENDAT)s/%(STARTFROM)s;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=rbend;
select, flag=twiss,pattern="XRP";
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
twiss, betx=%(ENDBX)s, alfx=%(ALFENDX)s, bety=%(ENDBY)s, alfy=%(ALFENDY)s,dx=%(DENDX)s,dy=%(DENDY)s,dpx=%(DPENDX)s,dpy=%(DPENDY)s, file="%(PATH)s/twiss_%(LABEL)s_cor_back.dat";


stop;

